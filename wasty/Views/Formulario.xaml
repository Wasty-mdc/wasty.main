<?xml version="1.0" encoding="utf-8"?>
<UserControl x:Class="wasty.Views.Formulario"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:local="clr-namespace:wasty.Views"
             xmlns:viewModels="clr-namespace:wasty.ViewModels" xmlns:utils="clr-namespace:wasty.Utils"
             xmlns:behaviors="clr-namespace:wasty.Utils.Behaviors"
             xmlns:models="clr-namespace:wasty.Models"
             Height="Auto" Width="Auto">

    <UserControl.Resources>

        <!-- Style para TextBlock -->
        <Style TargetType="TextBlock">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="Foreground" Value="#2D2D2D"/>
            <Setter Property="FontWeight" Value="Regular"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>

        <!-- Style para TextBox -->
        <Style TargetType="TextBox">
            <Setter Property="Padding" Value="8"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="BorderBrush" Value="{Binding ColorBorde}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="Margin" Value="0 0 0 10"/>
        </Style>

        <!-- Style para ComboBox -->
        <Style TargetType="ComboBox">
            <Setter Property="Padding" Value="8"/>
            <Setter Property="BorderThickness" Value="1.5"/>
            <Setter Property="BorderBrush" Value="{Binding ColorBorde}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="Margin" Value="0 0 0 10"/>
            <Setter Property="Validation.ErrorTemplate">
                <Setter.Value>
                    <ControlTemplate>
                        <StackPanel>
                            <Border BorderBrush="Red" BorderThickness="2">
                                <AdornedElementPlaceholder />
                            </Border>
                            <TextBlock Foreground="Red" FontSize="12"
                               Text="{Binding AdornedElement.(Validation.Errors)[0].ErrorContent, 
                                      RelativeSource={RelativeSource Self}}" />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style para DatePicker -->
        <Style TargetType="DatePicker">
            <Setter Property="Padding" Value="8"/>
            <Setter Property="BorderThickness" Value="1.5"/>
            <Setter Property="BorderBrush" Value="{Binding ColorBorde}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="Margin" Value="0 0 0 10"/>
        </Style>

        <!-- Style para Button -->
        <Style TargetType="Button">
            <Setter Property="Padding" Value="12 14"/>
            <Setter Property="Background" Value="#2E7D32"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontFamily" Value="Poppins"/>
        </Style>
        
        <!-- Plantilla para campos de texto -->
        <DataTemplate x:Key="TextoTemplate">
            <StackPanel Orientation="Vertical">
                <TextBlock Text="{Binding Nombre}"/>
                <TextBox Text="{Binding Valor, Mode=TwoWay}" />
            </StackPanel>
        </DataTemplate>

        <!-- Margin="48,0,48,12"-->

        <!-- Plantilla para campos numéricos -->
        <DataTemplate x:Key="NumeroTemplate">
            <StackPanel Orientation="Vertical">
                <TextBlock Text="{Binding Nombre}"/>
                <TextBox Text="{Binding Valor, Mode=TwoWay}"
                 PreviewTextInput="OnlyNumbers_PreviewTextInput"
                 LostFocus="ValidateDecimalFormat" />
            </StackPanel>
        </DataTemplate>

        <!-- Plantilla para campos de fecha -->
        <DataTemplate x:Key="FechaTemplate">
            <StackPanel Orientation="Vertical">
                <TextBlock Text="{Binding Nombre}" />
                <DatePicker SelectedDate="{Binding Valor, Mode=TwoWay}"/>
            </StackPanel>
        </DataTemplate>

        <!-- Plantilla para campos Picker -->
        <DataTemplate x:Key="PickerTemplate">
            <StackPanel Orientation="Vertical">
                <TextBlock Text="{Binding Nombre}"/>
                <ComboBox ItemsSource="{Binding Opciones}" SelectedItem="{Binding Valor, Mode=TwoWay}"/>
            </StackPanel>
        </DataTemplate>

        <!-- Plantilla para campos CheckBox -->
        <DataTemplate x:Key="CheckboxTemplate">
            <StackPanel Orientation="Horizontal">
                <CheckBox Content="{Binding Nombre}" IsChecked="{Binding EstaSeleccionado, Mode=TwoWay}"/>
            </StackPanel>
        </DataTemplate>

        <!-- Selector de Plantilla -->
        <utils:CampoTemplateSelector x:Key="CampoSelector"
                                     TextoTemplate="{StaticResource TextoTemplate}"
                                     NumeroTemplate="{StaticResource NumeroTemplate}"
                                     FechaTemplate="{StaticResource FechaTemplate}"
                                     PickerTemplate="{StaticResource PickerTemplate}"
                                     CheckboxTemplate="{StaticResource CheckboxTemplate}"/>

        <DataTemplate DataType="{x:Type models:CampoFormulario}">
            <TextBox Text="{Binding Valor, UpdateSourceTrigger=PropertyChanged}">
                <i:Interaction.Behaviors>
                    <Binding Path="TipoValidacion" Converter="{StaticResource BehaviorSelectorConverter}" />
                </i:Interaction.Behaviors>
            </TextBox>
        </DataTemplate>
        
        <!-- Fuente para títulos principales -->
        <Style x:Key="TitlePrimaryTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="28"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{Binding ColorBorde}"/>
            <Setter Property="FontFamily" Value="Poppins"/>
        </Style>

        <!-- Fuente para textos -->
        <Style x:Key="TextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="#2D2D2D"/>
            <Setter Property="FontWeight" Value="Regular"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>
        
        <!-- Style para ComboBox de Grupo Principal y Grupo Secundario -->
        <Style x:Key="CbStyle" TargetType="ComboBox">
            <Setter Property="Padding" Value="8"/>
            <Setter Property="BorderThickness" Value="1.5"/>
            <Setter Property="BorderBrush" Value="{Binding ColorBorde}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="Margin" Value="0 0 0 10"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- Fondo -->
        <Grid.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="White" Offset="0"/>
                <GradientStop Color="LightGreen" Offset="1"/>
            </LinearGradientBrush>
        </Grid.Background>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Generación de los bloques -->
                <ItemsControl ItemsSource="{Binding Bloques}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- Frame separador de cada bloque con color y color de borde -->
                            <Border BorderBrush="{Binding ColorBorde}" BorderThickness="3" CornerRadius="12" Padding="20" MaxWidth="1000" Margin="0, 30, 0, 10" Background="{Binding ColorFondo}">
                                <StackPanel>
                                    <!-- Titulo de cada bloque -->
                                    <TextBlock Text="{Binding Nombre}" Style="{StaticResource TitlePrimaryTextStyle}" Margin="0,0,0,12"/>

                                    <!-- Bloque de Grupo Principal y Grupo Secundario -->
                                    <StackPanel Orientation="Vertical"
                                                Visibility="{Binding IsFirst, Converter={x:Static local:Formulario.BooleanToVisibility}}">

                                        <!-- Grupo Principal -->
                                        <StackPanel Orientation="Vertical">
                                            <TextBlock Text="Grupo Principal" Style="{StaticResource TextStyle}"/>
                                            <ComboBox ItemsSource="{Binding DataContext.OpcionesGrupoPrincipal, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                SelectedItem="{Binding DataContext.GrupoPrincipalSeleccionado, Mode=TwoWay, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                Style="{StaticResource CbStyle}"/>
                                        </StackPanel>

                                        <!-- Grupo Secundario -->
                                        <StackPanel Orientation="Vertical">
                                            <TextBlock Text="Grupo Secundario" Style="{StaticResource TextStyle}"/>
                                            <ComboBox ItemsSource="{Binding DataContext.OpcionesGrupoSecundario, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                SelectedItem="{Binding DataContext.GrupoSecundarioSeleccionado, Mode=TwoWay, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                IsEnabled="{Binding DataContext.GrupoSecundarioHabilitado, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                Style="{StaticResource CbStyle}"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- Generación de campos dentro del bloque -->
                                    <ItemsControl ItemsSource="{Binding Campos}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel>
                                                    <!-- Texto de cada campo y campos-->
                                                    <ContentControl Content="{Binding}" 
                                                                    ContentTemplateSelector="{StaticResource CampoSelector}"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Botón guardar -->
                <!-- <Button Content="Guardar" Command="{Binding GuardarCommand}" IsEnabled="{Binding Path=GuardarCommand.CanExecute, RelativeSource={RelativeSource Self}}" Margin="25" Width="140" Height="Auto" FontSize="16"/> -->
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>